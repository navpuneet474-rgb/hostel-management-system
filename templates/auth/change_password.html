<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Change Password - Hostel Coordination System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-key text-blue-600 text-2xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">
                {% if is_first_login %}
                    Change Default Password
                {% else %}
                    Change Password
                {% endif %}
            </h1>
            <p class="text-gray-600">
                {% if is_first_login %}
                    Please set a new password to secure your account
                {% else %}
                    Update your account password
                {% endif %}
            </p>
        </div>

        <!-- User Info -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-user text-blue-600"></i>
                </div>
                <div>
                    <div class="font-medium text-gray-800">{{ user.name }}</div>
                    <div class="text-sm text-gray-600">{{ user.email }}</div>
                </div>
            </div>
        </div>

        {% if is_first_login %}
        <!-- First Time Login Notice -->
        <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg mb-6">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <strong>Security Notice:</strong> You must change your default password before accessing the system.
        </div>
        {% endif %}

        <!-- Password Change Form -->
        <form id="passwordForm" class="space-y-6">
            <!-- Current Password -->
            <div>
                <label for="current_password" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-lock mr-2"></i>Current Password
                </label>
                <div class="relative">
                    <input 
                        type="password" 
                        id="current_password" 
                        name="current_password" 
                        required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors pr-12"
                        placeholder="Enter your current password"
                    >
                    <button 
                        type="button" 
                        class="toggle-password absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                        data-target="current_password"
                    >
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <!-- New Password -->
            <div>
                <label for="new_password" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-key mr-2"></i>New Password
                </label>
                <div class="relative">
                    <input 
                        type="password" 
                        id="new_password" 
                        name="new_password" 
                        required 
                        minlength="6"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors pr-12"
                        placeholder="Enter your new password"
                    >
                    <button 
                        type="button" 
                        class="toggle-password absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                        data-target="new_password"
                    >
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="mt-2 text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    Password must be at least 6 characters long
                </div>
            </div>

            <!-- Confirm New Password -->
            <div>
                <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-check-double mr-2"></i>Confirm New Password
                </label>
                <div class="relative">
                    <input 
                        type="password" 
                        id="confirm_password" 
                        name="confirm_password" 
                        required 
                        minlength="6"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors pr-12"
                        placeholder="Confirm your new password"
                    >
                    <button 
                        type="button" 
                        class="toggle-password absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                        data-target="confirm_password"
                    >
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            {% if user_type == 'student' %}
            <!-- Additional Student Fields -->
            <div class="border-t pt-6">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Additional Information</h3>
                
                <!-- Mobile Number -->
                <div class="mb-4">
                    <label for="mobile_number" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-mobile-alt mr-2"></i>Mobile Number
                    </label>
                    <input 
                        type="tel" 
                        id="mobile_number" 
                        name="mobile_number" 
                        value="{{ user.mobile_number|default:'' }}"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                        placeholder="Enter your mobile number"
                    >
                </div>

                <!-- Roll Number (Optional) -->
                <div>
                    <label for="roll_number" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-id-card mr-2"></i>Roll Number <span class="text-gray-500">(Optional)</span>
                    </label>
                    <input 
                        type="text" 
                        id="roll_number" 
                        name="roll_number" 
                        value="{{ user.roll_number|default:'' }}"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                        placeholder="Enter your roll number"
                    >
                </div>
            </div>
            {% endif %}

            <!-- Error Message -->
            <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span id="errorText"></span>
            </div>

            <!-- Success Message -->
            <div id="successMessage" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg">
                <i class="fas fa-check-circle mr-2"></i>
                <span id="successText"></span>
            </div>

            <!-- Submit Button -->
            <button 
                type="submit" 
                id="submitButton"
                class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
                <span id="submitButtonText">
                    <i class="fas fa-save mr-2"></i>Change Password
                </span>
                <span id="submitButtonLoading" class="hidden">
                    <i class="fas fa-spinner fa-spin mr-2"></i>Updating...
                </span>
            </button>
        </form>

        {% if not is_first_login %}
        <!-- Cancel Button -->
        <div class="mt-4">
            <a 
                href="{% if user_type == 'student' %}/student/dashboard/{% else %}/staff/{% endif %}"
                class="block w-full text-center bg-gray-100 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-200 transition-colors"
            >
                <i class="fas fa-arrow-left mr-2"></i>Cancel
            </a>
        </div>
        {% endif %}
    </div>

    <script>
        // Toggle password visibility
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const passwordField = document.getElementById(targetId);
                const icon = this.querySelector('i');
                
                if (passwordField.type === 'password') {
                    passwordField.type = 'text';
                    icon.className = 'fas fa-eye-slash';
                } else {
                    passwordField.type = 'password';
                    icon.className = 'fas fa-eye';
                }
            });
        });

        // Password confirmation validation
        document.getElementById('confirm_password').addEventListener('input', function() {
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = this.value;
            
            if (confirmPassword && newPassword !== confirmPassword) {
                this.setCustomValidity('Passwords do not match');
                this.classList.add('border-red-500');
            } else {
                this.setCustomValidity('');
                this.classList.remove('border-red-500');
            }
        });

        // Handle form submission
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                current_password: formData.get('current_password'),
                new_password: formData.get('new_password'),
                confirm_password: formData.get('confirm_password'),
                mobile_number: formData.get('mobile_number') || '',
                roll_number: formData.get('roll_number') || ''
            };
            
            // Validate passwords match
            if (data.new_password !== data.confirm_password) {
                showMessage('errorMessage', 'New passwords do not match');
                return;
            }
            
            // Show loading state
            const submitButton = document.getElementById('submitButton');
            const submitButtonText = document.getElementById('submitButtonText');
            const submitButtonLoading = document.getElementById('submitButtonLoading');
            
            submitButton.disabled = true;
            submitButtonText.classList.add('hidden');
            submitButtonLoading.classList.remove('hidden');
            
            // Hide previous messages
            hideMessage('errorMessage');
            hideMessage('successMessage');
            
            try {
                const response = await fetch('/auth/change-password/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('successMessage', result.message || 'Password changed successfully!');
                    
                    // Redirect after success
                    setTimeout(() => {
                        window.location.href = result.redirect_url;
                    }, 2000);
                } else {
                    showMessage('errorMessage', result.error || 'Failed to change password. Please try again.');
                }
            } catch (error) {
                console.error('Password change error:', error);
                showMessage('errorMessage', 'An error occurred. Please try again.');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                submitButtonText.classList.remove('hidden');
                submitButtonLoading.classList.add('hidden');
            }
        });

        // Utility functions
        function showMessage(elementId, message) {
            const element = document.getElementById(elementId);
            const textElement = element.querySelector('span');
            textElement.textContent = message;
            element.classList.remove('hidden');
        }

        function hideMessage(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        function getCookie(name) {
            // First try to get from meta tag
            const token = document.querySelector('meta[name="csrf-token"]');
            if (token && name === 'csrftoken') {
                return token.getAttribute('content');
            }
            
            // Fallback to cookie
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Auto-focus current password field
        document.getElementById('current_password').focus();
    </script>
</body>
</html>