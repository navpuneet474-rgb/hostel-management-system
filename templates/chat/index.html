{% extends 'base.html' %}
{% load static %}

{% block title %}AI Hostel Chat - {{ user.name|default:"Guest" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
<style>
    /* Additional inline styles for enhanced features */
    .message-bubble {
        position: relative;
        word-wrap: break-word;
        max-width: 85%;
    }
    
    .message-bubble::before {
        content: '';
        position: absolute;
        width: 0;
        height: 0;
    }
    
    .message-sent::before {
        right: -8px;
        top: 10px;
        border-left: 8px solid #DCF8C6;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
    }
    
    .message-received::before {
        left: -8px;
        top: 10px;
        border-right: 8px solid white;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
    }
    
    .floating-action {
        position: fixed;
        bottom: 100px;
        right: 20px;
        z-index: 40;
    }
    
    .message-reactions {
        display: flex;
        gap: 4px;
        margin-top: 4px;
        flex-wrap: wrap;
    }
    
    .reaction-btn {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 2px 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .reaction-btn:hover {
        background: #f3f4f6;
        transform: scale(1.1);
    }
    
    .voice-recording {
        background: linear-gradient(45deg, #ef4444, #dc2626);
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    /* Suggestion chips */
    .suggestion-chip {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 16px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }
    
    .suggestion-chip:hover {
        background: #25D366;
        color: white;
        transform: translateY(-1px);
    }
    
    /* Search highlights */
    .search-highlight {
        background: yellow;
        padding: 1px 2px;
        border-radius: 2px;
    }
    
    .current-search-result {
        background: rgba(37, 211, 102, 0.1);
        border: 2px solid #25D366;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gradient-to-br from-blue-50 to-indigo-100 relative">
    <!-- Chat Container -->
    <div class="flex flex-col w-full max-w-5xl mx-auto bg-white shadow-2xl rounded-lg overflow-hidden">
        
        <!-- Enhanced Header -->
        <div class="bg-gradient-to-r from-whatsapp-dark-green to-green-600 text-white px-6 py-4 flex items-center justify-between shadow-lg">
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <div class="w-12 h-12 bg-whatsapp-green rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-robot text-white text-xl"></i>
                    </div>
                    <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-400 rounded-full border-2 border-white" id="ai-status-dot"></div>
                </div>
                <div>
                    <h1 class="font-bold text-xl">AI Hostel Assistant</h1>
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-300 rounded-full animate-pulse" id="activity-indicator"></div>
                        <p class="text-sm text-green-100" id="status-indicator">Online ‚Ä¢ Ready to help</p>
                    </div>
                </div>
            </div>
            
            <!-- Header Actions -->
            <div class="flex items-center space-x-4">
                <!-- Search Button -->
                <button id="search-toggle" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors" title="Search messages">
                    <i class="fas fa-search text-lg"></i>
                </button>
                
                <!-- Settings Button -->
                <button id="settings-toggle" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors" title="Settings">
                    <i class="fas fa-cog text-lg"></i>
                </button>
                
                <!-- Enhanced User Profile Display -->
                <div class="flex items-center space-x-3 bg-white bg-opacity-15 rounded-xl px-4 py-3 border border-white border-opacity-20">
                    <!-- User Avatar -->
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center shadow-lg">
                        {% if user.user_type == 'student' %}
                            <i class="fas fa-user-graduate text-white text-lg"></i>
                        {% elif user.user_type == 'staff' %}
                            <i class="fas fa-user-tie text-white text-lg"></i>
                        {% elif user.user_type == 'warden' %}
                            <i class="fas fa-user-shield text-white text-lg"></i>
                        {% else %}
                            <i class="fas fa-user text-white text-lg"></i>
                        {% endif %}
                    </div>
                    
                    <!-- User Information -->
                    <div class="text-right">
                        <div class="font-bold text-white text-lg leading-tight">
                            {% if user.user_type == 'student' and user.room_number %}
                                {{ user.name }} (Room {{ user.room_number }})
                            {% elif user.user_type == 'staff' and user.designation %}
                                {{ user.name }} ({{ user.designation }})
                            {% elif user.user_type == 'warden' and user.designation %}
                                {{ user.name }} ({{ user.designation }})
                            {% else %}
                                {{ user.name|default:"Unknown User" }}
                            {% endif %}
                        </div>
                        <!-- Role Badge -->
                        <div class="mt-1">
                            {% if user.user_type == 'student' %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    <i class="fas fa-graduation-cap mr-1"></i>Student
                                </span>
                            {% elif user.user_type == 'staff' %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                    <i class="fas fa-shield-alt mr-1"></i>Staff
                                </span>
                            {% elif user.user_type == 'warden' %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-crown mr-1"></i>Warden
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    <i class="fas fa-user mr-1"></i>User
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Bar (Hidden by default) -->
        <div id="search-bar" class="hidden bg-gray-50 border-b px-6 py-3">
            <div class="relative">
                <input type="text" id="search-input" placeholder="Search messages..." 
                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-whatsapp-green focus:border-transparent">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <button id="search-close" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Enhanced Messages Container -->
        <div class="flex-1 overflow-y-auto bg-gradient-to-b from-gray-50 to-white relative" id="messages-container">
            <div class="p-6 space-y-6" id="messages-list">
                <!-- Welcome Message -->
                <div class="flex justify-center">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl shadow-lg p-6 max-w-md text-center">
                        <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-robot text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">Welcome to AI Assistant!</h3>
                        <p class="text-blue-100 text-sm mb-4">
                            I'm here to help you with all your hostel needs. Just type naturally and I'll understand!
                        </p>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="bg-white bg-opacity-10 rounded-lg p-2">
                                <i class="fas fa-user-plus mb-1"></i>
                                <div>Guest Requests</div>
                            </div>
                            <div class="bg-white bg-opacity-10 rounded-lg p-2">
                                <i class="fas fa-calendar-alt mb-1"></i>
                                <div>Leave Applications</div>
                            </div>
                            <div class="bg-white bg-opacity-10 rounded-lg p-2">
                                <i class="fas fa-tools mb-1"></i>
                                <div>Maintenance</div>
                            </div>
                            <div class="bg-white bg-opacity-10 rounded-lg p-2">
                                <i class="fas fa-question-circle mb-1"></i>
                                <div>Rules & Policies</div>
                            </div>
                        </div>
                        <div class="text-xs text-blue-200 mt-4 flex items-center justify-center">
                            <i class="fas fa-clock mr-1"></i>
                            <span id="welcome-time"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scroll to bottom button -->
            <button id="scroll-to-bottom" class="hidden fixed bottom-32 right-8 bg-whatsapp-green text-white p-3 rounded-full shadow-lg hover:bg-whatsapp-dark-green transition-colors z-30">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>

        <!-- Enhanced Typing Indicator -->
        <div class="px-6 py-2 bg-gray-50 hidden" id="typing-indicator">
            <div class="flex justify-start">
                <div class="bg-white rounded-2xl px-4 py-3 shadow-sm border flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-whatsapp-green to-green-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                        <span class="text-sm text-gray-600 ml-2">AI is thinking...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Message Input -->
        <div class="bg-white border-t border-gray-200 p-6">
            <!-- Smart Suggestions (shown when relevant) -->
            <div id="smart-suggestions" class="hidden mb-4">
                <div class="text-xs text-gray-500 mb-2 flex items-center">
                    <i class="fas fa-lightbulb mr-1"></i>
                    Smart suggestions:
                </div>
                <div class="flex flex-wrap gap-2" id="suggestions-container">
                    <!-- Dynamic suggestions will be added here -->
                </div>
            </div>
            
            <form id="message-form" class="flex items-end space-x-3">
                <!-- Enhanced Attachment Menu -->
                <div class="relative">
                    <button type="button" id="attachment-btn" class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-whatsapp-green hover:to-green-500 hover:text-white rounded-full flex items-center justify-center transition-all duration-200 group">
                        <i class="fas fa-plus group-hover:rotate-45 transition-transform duration-200"></i>
                    </button>
                    
                    <!-- Attachment Menu -->
                    <div id="attachment-menu" class="hidden absolute bottom-14 left-0 bg-white rounded-2xl shadow-xl border p-2 min-w-48 z-50">
                        <button type="button" class="attachment-option w-full flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-xl transition-colors" data-type="image">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-image text-blue-600"></i>
                            </div>
                            <div class="text-left">
                                <div class="font-medium text-gray-800">Photo</div>
                                <div class="text-xs text-gray-500">Share an image</div>
                            </div>
                        </button>
                        <button type="button" class="attachment-option w-full flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-xl transition-colors" data-type="document">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-file-alt text-green-600"></i>
                            </div>
                            <div class="text-left">
                                <div class="font-medium text-gray-800">Document</div>
                                <div class="text-xs text-gray-500">Share a file</div>
                            </div>
                        </button>
                        <button type="button" class="attachment-option w-full flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-xl transition-colors" data-type="location">
                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-map-marker-alt text-red-600"></i>
                            </div>
                            <div class="text-left">
                                <div class="font-medium text-gray-800">Location</div>
                                <div class="text-xs text-gray-500">Share your location</div>
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- Enhanced Message Input -->
                <div class="flex-1 relative">
                    <div class="relative bg-gray-50 rounded-2xl border border-gray-200 focus-within:border-whatsapp-green focus-within:bg-white transition-all duration-200">
                        <textarea 
                            id="message-input" 
                            placeholder="Type your message here... (Press Enter to send, Shift+Enter for new line)"
                            class="w-full px-4 py-3 bg-transparent resize-none focus:outline-none text-gray-800 placeholder-gray-500"
                            rows="1"
                            maxlength="2000"
                        ></textarea>
                        
                        <!-- Input Actions -->
                        <div class="absolute right-2 bottom-2 flex items-center space-x-2">
                            <!-- Emoji Button -->
                            <button type="button" id="emoji-btn" class="p-2 text-gray-400 hover:text-whatsapp-green transition-colors rounded-full hover:bg-gray-100">
                                <i class="fas fa-smile text-lg"></i>
                            </button>
                            
                            <!-- Voice Message Button -->
                            <button type="button" id="voice-btn" class="p-2 text-gray-400 hover:text-whatsapp-green transition-colors rounded-full hover:bg-gray-100" title="Hold to record voice message">
                                <i class="fas fa-microphone text-lg"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Character Count -->
                    <div class="absolute -bottom-6 right-0 text-xs text-gray-400" id="char-count">0/2000</div>
                    
                    <!-- Emoji Picker (Hidden by default) -->
                    <div id="emoji-picker" class="hidden absolute bottom-14 right-0 bg-white rounded-2xl shadow-xl border p-4 w-80 max-h-64 overflow-y-auto z-50">
                        <div class="grid grid-cols-8 gap-2">
                            <!-- Common emojis -->
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">üòä</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">üòÇ</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">üòç</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">ü§î</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">üò¢</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">üò°</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">üëç</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">üëé</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">‚ù§Ô∏è</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">üéâ</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">üî•</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">‚≠ê</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">‚úÖ</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">‚ùå</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">üè†</button>
                            <button type="button" class="emoji-btn p-2 hover:bg-gray-100 rounded text-xl">üõèÔ∏è</button>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Send Button -->
                <button 
                    type="submit" 
                    id="send-button"
                    class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-whatsapp-green to-green-500 hover:from-whatsapp-dark-green hover:to-green-600 text-white rounded-full flex items-center justify-center transition-all duration-200 disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transform hover:scale-105 disabled:transform-none"
                    disabled
                >
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Floating Action Buttons -->
    <div class="floating-action">
        <button id="clear-chat" class="mb-3 w-12 h-12 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center" title="Clear chat">
            <i class="fas fa-trash-alt"></i>
        </button>
        <button id="export-chat" class="w-12 h-12 bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center" title="Export chat">
            <i class="fas fa-download"></i>
        </button>
    </div>
    
    <!-- Hidden file inputs -->
    <input type="file" id="image-input" accept="image/*" class="hidden">
    <input type="file" id="document-input" accept=".pdf,.doc,.docx,.txt" class="hidden">
</div>

<!-- Enhanced Connection Status Modal -->
<div id="connection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-sm mx-4 text-center shadow-2xl">
        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-wifi text-red-600 text-3xl"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-3">Connection Lost</h3>
        <p class="text-gray-600 mb-6">We're trying to reconnect you to the AI assistant...</p>
        <div class="flex justify-center mb-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-whatsapp-green"></div>
        </div>
        <button id="retry-connection" class="bg-whatsapp-green text-white px-6 py-2 rounded-full hover:bg-whatsapp-dark-green transition-colors">
            Retry Connection
        </button>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-900">Chat Settings</h3>
            <button id="settings-close" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <!-- Notifications -->
            <div class="flex items-center justify-between">
                <div>
                    <div class="font-medium text-gray-800">Notifications</div>
                    <div class="text-sm text-gray-500">Get notified of new messages</div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="notifications-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-whatsapp-green/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-whatsapp-green"></div>
                </label>
            </div>
            
            <!-- Sound -->
            <div class="flex items-center justify-between">
                <div>
                    <div class="font-medium text-gray-800">Sound Effects</div>
                    <div class="text-sm text-gray-500">Play sounds for messages</div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="sound-toggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-whatsapp-green/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-whatsapp-green"></div>
                </label>
            </div>
            
            <!-- Theme -->
            <div>
                <div class="font-medium text-gray-800 mb-2">Theme</div>
                <select id="theme-select" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-whatsapp-green">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="auto">Auto</option>
                </select>
            </div>
            
            <!-- Font Size -->
            <div>
                <div class="font-medium text-gray-800 mb-2">Font Size</div>
                <input type="range" id="font-size-slider" min="12" max="20" value="14" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>Small</span>
                    <span>Large</span>
                </div>
            </div>
        </div>
        
        <div class="flex space-x-3 mt-6">
            <button id="settings-reset" class="flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors">
                Reset
            </button>
            <button id="settings-save" class="flex-1 bg-whatsapp-green text-white py-2 px-4 rounded-lg hover:bg-whatsapp-dark-green transition-colors">
                Save
            </button>
        </div>
    </div>
</div>

<!-- Voice Recording Modal -->
<div id="voice-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-sm mx-4 text-center shadow-2xl">
        <div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6 voice-recording">
            <i class="fas fa-microphone text-red-600 text-3xl"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-3">Recording Voice Message</h3>
        <p class="text-gray-600 mb-4">Speak now... <span id="recording-time">0:00</span></p>
        <div class="flex space-x-3">
            <button id="voice-cancel" class="flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors">
                Cancel
            </button>
            <button id="voice-send" class="flex-1 bg-whatsapp-green text-white py-2 px-4 rounded-lg hover:bg-whatsapp-dark-green transition-colors">
                Send
            </button>
        </div>
    </div>
</div>

<!-- Clear Chat Confirmation Modal -->
<div id="clear-chat-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-2xl">
        <div class="text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash-alt text-red-600 text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">Clear Chat History?</h3>
            <p class="text-gray-600 mb-6">This action cannot be undone. All your messages will be permanently deleted.</p>
            <div class="flex space-x-3">
                <button id="clear-chat-cancel" class="flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors">
                    Cancel
                </button>
                <button id="clear-chat-confirm" class="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                    Clear
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Make user context available to JavaScript
    window.userContext = {
        user_id: '{{ user.name|default:"guest"|slugify }}',
        name: '{{ user.name|default:"Guest User" }}',
        role: '{{ user.user_type|default:"guest" }}',
        room_number: {% if user.user_type == 'student' %}'{{ user.room_number|default:"" }}'{% else %}null{% endif %},
        designation: {% if user.user_type == 'staff' or user.user_type == 'warden' %}'{{ user.designation|default:"Staff Member" }}'{% else %}null{% endif %},
        email: '{{ user.email|default:"" }}'
    };
</script>

<!-- Immediate fix for submit button -->
<script>
    // Immediate initialization - runs as soon as this script loads
    (function() {
        console.log('Immediate chat fix loading...');
        
        function initImmediateChat() {
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            
            if (!messageForm || !messageInput || !sendButton) {
                console.log('Elements not ready, retrying...');
                setTimeout(initImmediateChat, 100);
                return;
            }
            
            console.log('Setting up immediate chat handlers...');
            
            // Remove any existing event listeners
            const newForm = messageForm.cloneNode(true);
            messageForm.parentNode.replaceChild(newForm, messageForm);
            
            const newInput = newForm.querySelector('#message-input');
            const newButton = newForm.querySelector('#send-button');
            
            async function sendMessage() {
                const content = newInput.value.trim();
                if (!content) return;
                
                console.log('Sending message immediately:', content);
                
                // Disable button
                newButton.disabled = true;
                newButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                // Add message to UI
                const messagesList = document.getElementById('messages-list');
                if (messagesList) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'flex justify-end mb-4';
                    messageDiv.innerHTML = `
                        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl bg-green-500 text-white">
                            ${content}
                        </div>
                    `;
                    messagesList.appendChild(messageDiv);
                    
                    // Scroll to bottom
                    const container = document.getElementById('messages-container');
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                }
                
                // Clear input
                newInput.value = '';
                
                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                    
                    const response = await fetch('/api/messages/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify({
                            content: content,
                            user_context: window.userContext
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.ai_response && messagesList) {
                            const aiDiv = document.createElement('div');
                            aiDiv.className = 'flex justify-start mb-4';
                            aiDiv.innerHTML = `
                                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl bg-white text-gray-800 border border-gray-200">
                                    ${data.ai_response}
                                </div>
                            `;
                            messagesList.appendChild(aiDiv);
                            
                            // Scroll to bottom
                            const container = document.getElementById('messages-container');
                            if (container) {
                                container.scrollTop = container.scrollHeight;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                } finally {
                    // Re-enable button
                    newButton.disabled = false;
                    newButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                }
            }
            
            // Add event listeners
            newForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMessage();
            });
            
            newButton.addEventListener('click', (e) => {
                e.preventDefault();
                sendMessage();
            });
            
            newInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            newInput.addEventListener('input', () => {
                newButton.disabled = !newInput.value.trim();
            });
            
            console.log('Immediate chat fix applied successfully!');
        }
        
        // Try to initialize immediately, or wait for DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initImmediateChat);
        } else {
            initImmediateChat();
        }
    })();
</script>

<script src="{% static 'js/chat.js' %}"></script>
<script>
    // Additional initialization and legacy support
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize welcome time if not already set
        const welcomeTimeElement = document.getElementById('welcome-time');
        if (welcomeTimeElement && !welcomeTimeElement.textContent) {
            welcomeTimeElement.textContent = new Date().toLocaleTimeString();
        }
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to send message
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const messageForm = document.getElementById('message-form');
                if (messageForm) {
                    messageForm.dispatchEvent(new Event('submit'));
                }
            }
            
            // Escape to clear input
            if (e.key === 'Escape') {
                const messageInput = document.getElementById('message-input');
                if (messageInput && messageInput === document.activeElement) {
                    messageInput.value = '';
                    messageInput.dispatchEvent(new Event('input'));
                }
            }
        });
        
        // Add touch support for mobile
        let touchStartY = 0;
        const messagesContainer = document.getElementById('messages-container');
        
        messagesContainer.addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
        });
        
        messagesContainer.addEventListener('touchmove', function(e) {
            const touchY = e.touches[0].clientY;
            const touchDiff = touchStartY - touchY;
            
            // Prevent overscroll
            if (messagesContainer.scrollTop === 0 && touchDiff < 0) {
                e.preventDefault();
            }
            
            if (messagesContainer.scrollTop >= messagesContainer.scrollHeight - messagesContainer.clientHeight && touchDiff > 0) {
                e.preventDefault();
            }
        });
        
        // Add notification support
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // Add service worker for offline support (if available)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/js/sw.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration);
                })
                .catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
        }
    });
</script>
{% endblock %}