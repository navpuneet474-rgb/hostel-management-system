# Implementation Plan: Digital Pass Fixes and Enhancements

## Overview

This implementation plan addresses critical bugs in the AI Hostel Coordination System's digital pass and leave request functionality, plus adds a pass history tracking feature. The fixes will be implemented incrementally, with testing at each stage to ensure correctness.

## Tasks

- [x] 1. Fix user-specific digital pass display
  - [x] 1.1 Update get_digital_passes() view to filter by authenticated user
    - Modify `core/views.py` get_digital_passes() function
    - Add filter: `DigitalPass.objects.filter(student=request.user.user_object)`
    - Update response to use authenticated user's data (name, student_id, room_number)
    - Remove any hardcoded student data from response
    - _Requirements: 1.1, 1.2, 1.3_
  - [ ] 1.2 Write property test for user-specific pass filtering
    - **Property 1: User-Specific Pass Filtering**
    - **Validates: Requirements 1.1, 1.2, 1.3**
    - Create test in `core/tests/test_digital_pass_display.py`
    - Use hypothesis to generate random students and passes
    - Verify each student only sees their own passes
    - Verify all pass data matches authenticated user's database record
  - [ ]\* 1.3 Write unit test for empty pass list edge case
    - Test student with zero passes receives appropriate empty state
    - Verify response structure is correct
    - _Requirements: 1.4_

- [x] 2. Fix pass generation to use authenticated user data
  - [x] 2.1 Update PDF generation service to use student relationship
    - Modify `core/services/pdf_generation_service.py`
    - Replace hardcoded 'John Doe' with `digital_pass.student.name`
    - Update all student fields to use `digital_pass.student.*`
    - Ensure PDF template receives correct context data
    - _Requirements: 2.1, 2.2, 2.3, 2.4_
  - [ ]\* 2.2 Write property test for pass generation data
    - **Property 2: Pass Generation Uses Authenticated User Data**
    - **Validates: Requirements 2.1, 2.2, 2.3, 2.4**
    - Create test in `core/tests/test_pass_generation.py`
    - Generate random student data
    - Create passes and verify generated data matches student record
    - Verify no hardcoded values appear in generated passes
  - [ ]\* 2.3 Write unit test for PDF content verification
    - Generate a pass PDF and parse content
    - Verify student name appears in PDF
    - Verify no hardcoded names appear
    - _Requirements: 2.4_

- [ ] 3. Checkpoint - Verify student-side fixes
  - Ensure all tests pass, ask the user if questions arise.

- [x] 4. Fix leave request visibility on staff dashboard
  - [x] 4.1 Update dashboard service to correctly filter pending requests
    - Modify `core/services/dashboard_service.py`
    - Change status filter to case-insensitive: `status__iexact='pending'`
    - Add `select_related('student', 'approved_by')` for eager loading
    - Implement cache invalidation on force refresh
    - Ensure `absence_id` (UUID) is included in response data
    - _Requirements: 3.1, 3.3, 3.4_
  - [ ]\* 4.2 Write property test for pending request filtering
    - **Property 3: Pending Leave Requests Visibility**
    - **Validates: Requirements 3.1, 3.3, 3.4**
    - Create test in `core/tests/test_leave_request_visibility.py`
    - Generate random leave requests with various statuses and dates
    - Verify only pending requests are returned
    - Verify old pending requests are not excluded
  - [ ]\* 4.3 Write unit test for empty pending list edge case
    - Test dashboard with zero pending requests
    - Verify appropriate empty state handling
    - _Requirements: 3.5_

- [x] 5. Fix reason field validation for approvals vs rejections
  - [x] 5.1 Update approve_leave_request() to make reason optional
    - Modify `core/views.py` approve_leave_request() function
    - Remove validation that requires reason field
    - Use default value if reason not provided: 'Approved by warden'
    - _Requirements: 4.1, 4.4_
  - [x] 5.2 Update reject_leave_request() to require reason
    - Modify `core/views.py` reject_leave_request() function
    - Add validation: check if reason is None, empty, or whitespace-only
    - Return 400 error with message "Rejection reason is required"
    - _Requirements: 4.2, 4.3_
  - [x] 5.3 Update frontend validation logic
    - Modify `static/js/staff-dashboard.js` confirmLeaveAction() function
    - Only validate reason for rejection actions
    - Allow approval without reason
    - Update UI labels to indicate optional vs required
    - _Requirements: 4.1, 4.2_
  - [ ]\* 5.4 Write property test for conditional reason validation
    - **Property 4: Conditional Reason Validation**
    - **Validates: Requirements 4.1, 4.2, 4.3, 4.4**
    - Create test in `core/tests/test_reason_validation.py`
    - Test approvals with and without reasons (both should succeed)
    - Test rejections without reason (should fail)
    - Test rejections with whitespace-only reason (should fail)
    - Test rejections with valid reason (should succeed)

- [x] 6. Fix UUID validation error in approval/rejection
  - [x] 6.1 Update frontend to send absence_id (UUID) consistently
    - Modify `static/js/staff-dashboard.js` renderRequestCard() function
    - Ensure data attribute uses `request.absence_id` not `request.id`
    - Verify UUID is preserved through frontend processing
    - _Requirements: 5.1, 8.1, 8.2, 8.4, 8.5_
  - [x] 6.2 Update dashboard service to include absence_id in response
    - Modify `core/services/dashboard_service.py`
    - Add 'absence_id' to values() call in get_pending_absence_requests()
    - Convert UUID to string: `str(req['absence_id'])`
    - _Requirements: 7.5, 8.1_
  - [x] 6.3 Add UUID validation error handling in backend
    - Modify `core/views.py` approve_leave_request() and reject_leave_request()
    - Add try-except for UUID validation errors
    - Return descriptive error: "Invalid UUID format. Expected format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    - _Requirements: 5.2, 5.4, 5.5_
  - [ ]\* 6.4 Write property test for UUID consistency
    - **Property 5: UUID Format Consistency**
    - **Validates: Requirements 5.1, 5.2, 8.1, 8.2, 8.3, 8.4, 8.5**
    - Create test in `core/tests/test_uuid_consistency.py`
    - Generate random valid UUIDs
    - Test approval/rejection with valid UUIDs (should succeed)
    - Verify UUID is preserved through frontend-backend communication
  - [ ]\* 6.5 Write property test for UUID validation errors
    - **Property 6: UUID Validation Error Messages**
    - **Validates: Requirements 5.4, 5.5**
    - Generate random invalid UUID formats (numeric IDs, malformed strings)
    - Test that each invalid format is rejected
    - Verify error messages are descriptive
  - [ ]\* 6.6 Write unit tests for specific UUID validation cases
    - Test numeric ID "8" is rejected
    - Test malformed UUID "abc-123" is rejected
    - Test empty string is rejected
    - Test valid UUID is accepted
    - _Requirements: 5.2, 5.5_

- [ ] 7. Checkpoint - Verify staff-side fixes
  - Ensure all tests pass, ask the user if questions arise.

- [x] 8. Implement pass history tracking feature
  - [x] 8.1 Create get_pass_history() view
    - Create new function in `core/views.py`
    - Query DigitalPass and AbsenceRecord models
    - Implement filtering by date range, student name, pass type, status
    - Combine results from both models
    - Sort by created_at descending
    - Include all required fields in response
    - Add IsStaffOnly permission check
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.7_
  - [x] 8.2 Create export_pass_history() view
    - Create new function in `core/views.py`
    - Reuse get_pass_history logic for data retrieval
    - Generate CSV format with all required fields
    - Set appropriate content-type and headers
    - Add IsStaffOnly permission check
    - _Requirements: 6.6, 6.7_
  - [x] 8.3 Add URL routes for pass history endpoints
    - Modify `core/urls.py`
    - Add route: `path('pass-history/', views.get_pass_history)`
    - Add route: `path('pass-history/export/', views.export_pass_history)`
    - _Requirements: 6.1, 6.6_
  - [x] 8.4 Create pass history frontend template
    - Create `templates/staff/pass_history.html`
    - Add filter controls (date range, student name, status)
    - Add table to display history records
    - Add export button
    - Add refresh button
    - Style with Tailwind CSS to match existing UI
    - _Requirements: 6.1, 6.3, 6.6_
  - [x] 8.5 Create pass history JavaScript functionality
    - Create `static/js/pass-history.js`
    - Implement loadPassHistory() function
    - Implement applyFilters() function
    - Implement exportHistory() function
    - Implement refreshHistory() function
    - Handle API responses and errors
    - _Requirements: 6.1, 6.3, 6.6_
  - [x] 8.6 Add pass history link to staff dashboard navigation
    - Modify `templates/staff/dashboard.html`
    - Add navigation link to pass history page
    - _Requirements: 6.1_
  - [ ]\* 8.7 Write property test for pass history completeness
    - **Property 8: Pass History Completeness**
    - **Validates: Requirements 6.1, 6.2**
    - Create test in `core/tests/test_pass_history.py`
    - Generate random digital passes and absence records
    - Verify all records are returned
    - Verify all required fields are present
    - Verify both approved and rejected passes are included
  - [ ]\* 8.8 Write property test for pass history filtering
    - **Property 9: Pass History Filtering**
    - **Validates: Requirements 6.3**
    - Generate random pass history data
    - Apply various filter combinations
    - Verify results match filter criteria
    - Verify all matching records are included
  - [ ]\* 8.9 Write property test for pass history sort order
    - **Property 11: Pass History Sort Order**
    - **Validates: Requirements 6.5**
    - Generate passes with random timestamps
    - Verify results are sorted by created_at descending
  - [ ]\* 8.10 Write unit test for pass history access control
    - Test staff user can access pass history (should succeed)
    - Test admin user can access pass history (should succeed)
    - Test student user cannot access pass history (should fail with 403)
    - _Requirements: 6.7_
  - [ ]\* 8.11 Write unit test for CSV export format
    - Export pass history to CSV
    - Verify CSV headers are correct
    - Verify CSV contains all required fields
    - Verify CSV format is valid
    - _Requirements: 6.6_

- [ ] 9. Checkpoint - Verify pass history feature
  - Ensure all tests pass, ask the user if questions arise.

- [ ] 10. Integration testing and final verification
  - [ ] 10.1 Run full test suite
    - Execute all unit tests
    - Execute all property tests
    - Verify all tests pass
    - Fix any failing tests
  - [ ] 10.2 Manual end-to-end testing
    - Test student login and digital pass display
    - Test pass generation with correct student data
    - Test staff dashboard shows pending requests
    - Test approval without reason
    - Test rejection with and without reason
    - Test pass history display and filtering
    - Test pass history export
    - Verify no UUID validation errors
  - [x] 10.3 Update documentation
    - Document new pass history feature in README
    - Document API endpoints for pass history
    - Document any configuration changes
  - [ ] 10.4 Final checkpoint
    - Ensure all tests pass, ask the user if questions arise.

## Notes

- Tasks marked with `*` are optional test tasks that can be skipped for faster MVP
- Each task references specific requirements for traceability
- Checkpoints ensure incremental validation
- Property tests validate universal correctness properties
- Unit tests validate specific examples and edge cases
- All fixes maintain backward compatibility with existing functionality
- No database migrations required - all necessary fields already exist
